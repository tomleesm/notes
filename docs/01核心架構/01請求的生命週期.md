# 請求的生命週期

## 簡介

在「真實世界」中使用任何工具時，如果你瞭解該工具的工作原理，你會更加自信。應用程式開發也不例外。當您瞭解開發工具的功能時，你會覺得使用它們更舒服、更自信。

本文的目的是讓您對 Laravel 框架的工作原理有一個良好的、高層次的理解。通過更好地瞭解整個框架，一切感覺都不那麼「神奇」，你將更有信心建構你的應用程式。如果你不明白所有的規則，不要灰心！只要試著對正在發生的事情有一個基本的掌握，你的知識就會隨著你探索文件的其他部分而增長。

## 生命週期概述

### 第一步

Laravel 應用程式的所有請求的入口點都是 `public/index.php` 檔案。所有請求都由你的 web 伺服器（Apache/Nginx）組態定向到此檔案。那個 `index.php` 檔案不包含太多程式碼。相反，它是載入框架其餘部分的起點。

`index.php` 檔案將載入 Composer 生成的自動載入器定義，然後從 `bootstrap/app.php` 中檢索 Laravel 應用程式的實例。Laravel 本身採取的第一個操作是建立應用 / [服務容器](/docs/laravel/10.x/container) 的實例。

### HTTP / Console 核心

接下來，根據進入應用的請求類型，傳入的請求將被傳送到 HTTP 核心或者 Console 核心。這兩個核心充當所有請求流經的中心位置。現在，我們只關注位於`app/Http/Kernel.php`中的 HTTP 核心。

HTTP 核心繼承了`Illuminate\Foundation\Http\Kernel`類，該類定義了一個將在執行請求之前運行的`bootstrappers` 陣列。這些啟動載入器用來組態異常處理、組態日誌、[檢測應用程式環境](/docs/laravel/10.x/configuration#environment-configuration)，並執行在實際處理請求之前需要完成的其他任務。通常，這些類處理你無需擔心的內部 Laravel 組態。

HTTP 核心還定義了一個 HTTP [中介軟體](/docs/laravel/10.x/middleware)列表，所有請求在被應用程式處理之前都必須通過該列表。這些中介軟體處理讀寫[HTTP  session ](/docs/laravel/10.x/session) ，確定應用程式是否處於維護模式， [校驗 CSRF 令牌](/docs/laravel/10.x/csrf), 等等。我們接下來會做詳細的討論。

HTTP 核心的`handle`方法的簽名非常簡單：它接收`Request`介面並返回`Response`介面。把核心想像成一個代表整個應用程式的大黑匣子。向它提供 HTTP 請求，它將返回 HTTP 響應。

### 服務提供者

最重要的核心引導操作之一是為應用程式載入[服務提供者 ](/docs/laravel/10.x/providers)。應用程式的所有服務提供程序都在`config/app.php`檔案中的`providers` 陣列。

Laravel 將遍歷這個提供者列表並實例化它們中的每一個。實例化提供程序後，將在所有提供程序上呼叫`register`方法。然後，一旦所有的提供者都被註冊了，就會對每個提供程序呼叫`boot`方法。服務提供者可能依賴於在執行`boot`方法時註冊並可用的每個容器繫結。

服務提供者負責引導框架的所有不同元件，如資料庫、佇列、驗證和路由元件。基本上，Laravel 提供的每個主要功能都是由服務提供商引導和組態的。由於它們引導和組態框架提供的許多特性，服務提供者是整個 Laravel 引導過程中最重要的部分。

### 路由

應用程式中最重要的服務提供者之一是`App\Providers\RouteServiceProvider`。此服務提供者載入應用程式的`routes`目錄中包含的路由檔案。繼續，打開`RouteServiceProvider`程式碼，看看它是如何工作的！

一旦應用程式被引導並且所有服務提供者都被註冊，`Request`將被傳遞給路由器進行調度。路由器將請求傳送到路由或 controller ，並運行任何路由特定的中介軟體。

中介軟體為過濾或檢查進入應用程式的 HTTP 請求提供了一種方便的機制。例如，Laravel 包含一個這樣的中介軟體，用於驗證應用程式的使用者是否經過身份驗證。如果使用者未通過身份驗證，中介軟體將使用者重新導向到登錄頁。但是，如果使用者經過身份驗證，中介軟體將允許請求進一步進入應用程式。一些中介軟體被分配給應用程式中的所有路由，比如那些在 HTTP 核心的`$middleware`屬性中定義的路由，而一些只被分配給特定的路由或路由組。你可以通過閱讀完整的[中介軟體文件](/docs/laravel/10.x/middleware)來瞭解關於中介軟體的資訊。

如果請求通過了所有匹配路由分配的中介軟體，則執行路由或 controller 方法，並通過路由的中介軟體鏈路返回路由或 controller 方法的響應。

### 最後

一旦路由或 controller 方法返回一個響應，該響應將通過路由的中介軟體返回，從而使應用程式有機會修改或檢查傳出的響應。

最後，一旦響應通過中介軟體返回，HTTP 核心的`handle`方法將返迴響應對象，並且`index.php`檔案在返回的響應上呼叫`send`方法。`send`方法將響應內容傳送到使用者的 Web 瀏覽器。至此，我們已經完成了整個 Laravel 請求生命週期的旅程！

## 關注服務提供者

服務提供者確實是引導 Laravel 應用程式的關鍵。建立應用程式實例，註冊服務提供者，並將請求傳遞給引導應用程式。就這麼簡單！

牢牢掌握服務提供者的建構和其對 Laravel 應用處理機制的原理是非常有價值的。你的應用的默認服務提供會存放在`app/Providers`目錄下面。

默認情況下，`AppServiceProvider`是空白的。這裡是用於你新增應用自身的引導處理和服務容器繫結的一個非常棒的地方。在大型項目中，你可能希望建立多個服務提供者，每個服務提供者都為應用程式使用的特定服務提供更細粒度的引導。

